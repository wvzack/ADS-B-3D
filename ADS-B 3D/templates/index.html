<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3D ADS-B Map with Table</title>
    <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.74/Build/Cesium/Widgets/widgets.css" type="text/css">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.74/Build/Cesium/Cesium.js"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #container {
            display: flex;
            width: 100%;
            height: 100%;
        }
        #cesiumContainer {
            width: 70%;
            height: 100%;
        }
        #tableContainer {
            width: 30%;
            height: 100%;
            background-color: #f0f0f0;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="cesiumContainer"></div>
        <div id="tableContainer">
            <table id="aircraftTable">
                <thead>

                    <tr>
                        <th>Flight</th>
                        <th>Altitude (ft)</th>
                        <th>Speed (knots)</th>
                        <th>Track (&deg;)</th>
                        <th>Squawk</th>
                        <th>ICAO</th>
                        <th>Position Age</th>
                        <th>Age</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data rows will be added here -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
		// replace with your cesium api token
        Cesium.Ion.defaultAccessToken = '';
        

        



        var viewer = new Cesium.Viewer('cesiumContainer');

        viewer.animation.container.style.visibility = 'hidden';
        viewer.timeline.container.style.visibility = 'hidden';
        viewer.forceResize();

        var aircraftEntities = {};

        function updateAircraft(data) {
            var aircraftCount = 0;
            var updatedAircraft = new Set();
            var tbody = document.getElementById('aircraftTable').querySelector('tbody');


            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }



            data.aircraft.forEach(function (plane) {
                if (plane.seen_pos) {
                    aircraftCount += 1;
                    updatedAircraft.add(plane.hex);

                    var row = document.getElementById(plane.hex);
                    if (!row) {
                        row = tbody.insertRow();
                        row.setAttribute('id', plane.hex);
                        row.insertCell(0).textContent = plane.flight || 'N/A';
                        row.insertCell(1).textContent = plane.alt_geom || 'N/A';
                        row.insertCell(2).textContent = plane.gs || 'N/A';
                        row.insertCell(3).textContent = plane.track || 'N/A';
                        row.insertCell(4).textContent = plane.squawk || 'N/A';
                        row.insertCell(5).textContent = plane.hex || 'N/A';
                        row.insertCell(6).textContent = plane.seen_pos;
                        row.insertCell(7).textContent = plane.seen;
                    } else {
                        row.cells[0].textContent = plane.flight || 'N/A';
                        row.cells[1].textContent = plane.alt_geom || 'N/A';
                        row.cells[2].textContent = plane.gs || 'N/A';
                        row.cells[3].textContent = plane.track || 'N/A';
                        row.cells[4].textContent = plane.squawk || 'N/A';
                        row.cells[5].textContent = plane.hex || 'N/A';
                        row.cells[6].textContent = plane.seen_pos;
                        row.cells[7].textContent = plane.seen;
                    }

                    if (plane.lat && plane.lon && plane.alt_geom) {
						

                        var position = Cesium.Cartesian3.fromDegrees(plane.lon, plane.lat, plane.alt_geom);    
                        var heading = Cesium.Math.toRadians(plane.track + -90);
                        var orientation = Cesium.Transforms.headingPitchRollQuaternion(position, new Cesium.HeadingPitchRoll(heading, 0.0, 0.0));

                        var description = `
                            <table>
                                <tr><th>Flight</th><td>${plane.flight}</td></tr>
                                <tr><th>Altitude</th><td>${plane.alt_geom} ft</td></tr>
                                <tr><th>Speed</th><td>${plane.gs} knots</td></tr>
                                <tr><th>Track</th><td>${plane.track}&deg;</td></tr>
                                <tr><th>Squawk</th><td>${plane.squawk}</td></tr>
                                <tr><th>ICAO</th><td>${plane.hex}</td></tr>
                                <tr><th>Position age</th><td>${plane.seen_pos}</td></tr>
                            </table>
                        `;

                        if (!aircraftEntities[plane.hex]) {
                            aircraftEntities[plane.hex] = viewer.entities.add({
                                id: plane.hex,
                                position: position,
                                orientation: orientation,
                                model: {
                                    uri: '/models/' + plane.category + '.glb',
                                    scale: 10.0
                                },
                                label: {
                                    text: plane.flight || 'N/A',
                                    font: '14pt sans-serif',
                                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                    outlineWidth: 2,
                                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                                    pixelOffset: new Cesium.Cartesian2(0, -9)
                                },
                                description: description
                            });
                        } else {
                            aircraftEntities[plane.hex].position = position;
                            aircraftEntities[plane.hex].orientation = orientation;
                            aircraftEntities[plane.hex].description = description;
                        }
                    }
                }
            });

            document.title = `(${aircraftCount}) 3D Map`;

            for (var id in aircraftEntities) {
                if (!updatedAircraft.has(id)) {
                    viewer.entities.remove(aircraftEntities[id]);
                    delete aircraftEntities[id];
                }
            }
        }

        function fetchADSBBData() {
            fetch('/adsb_data')
                .then(response => response.json())
                .then(data => {
                    updateAircraft(data);
                })
                .catch(error => console.error('Error fetching ADS-B data:', error));
        }

        setInterval(function() {

            fetchADSBBData();
        }, 500);
    </script>
</body>
</html>
